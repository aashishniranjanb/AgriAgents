<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <title>AgroSense AI | Smart Irrigation Control</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">

  <style>
    :root {
      --bg: #f8fafc;
      --card: #ffffff;
      --border: #e2e8f0;
      --text: #1e293b;
      --muted: #64748b;
      --blue: #2563eb;
      --green: #16a34a;
      --amber: #d97706;
      --red: #dc2626;
      --cyan: #0891b2;
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      background: var(--bg);
      color: var(--text);
      font-family: 'Inter', system-ui, sans-serif;
      padding: 24px;
      min-height: 100vh;
    }

    header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 32px;
      padding-bottom: 16px;
      border-bottom: 2px solid var(--border);
    }

    .brand {
      font-size: 1.5rem;
      font-weight: 800;
      color: var(--green);
    }

    .status-badge {
      display: flex;
      align-items: center;
      gap: 8px;
      background: #dcfce7;
      color: var(--green);
      padding: 8px 16px;
      border-radius: 24px;
      font-weight: 600;
      font-size: 0.85rem;
    }

    .pulse {
      width: 10px;
      height: 10px;
      background: var(--green);
      border-radius: 50%;
      animation: pulse 1.5s infinite;
    }

    @keyframes pulse {

      0%,
      100% {
        opacity: 1;
        transform: scale(1);
      }

      50% {
        opacity: 0.5;
        transform: scale(0.9);
      }
    }

    /* MAIN LAYOUT */
    .main-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 24px;
    }

    /* DECISION HERO CARD */
    .decision-hero {
      grid-column: 1 / -1;
      background: var(--card);
      border: 2px solid var(--border);
      border-radius: 16px;
      padding: 32px;
      display: grid;
      grid-template-columns: 1fr 1fr 1fr;
      gap: 24px;
      align-items: center;
    }

    .decision-block {
      text-align: center;
    }

    .decision-label {
      font-size: 0.75rem;
      text-transform: uppercase;
      letter-spacing: 1px;
      color: var(--muted);
      margin-bottom: 8px;
    }

    .decision-value {
      font-size: 3rem;
      font-weight: 800;
    }

    .decision-value.HOLD {
      color: var(--green);
    }

    .decision-value.IRRIGATE {
      color: var(--blue);
    }

    .decision-value.DELAY {
      color: var(--amber);
    }

    .decision-value.EMERGENCY_STOP {
      color: var(--red);
    }

    .pump-status {
      display: inline-block;
      padding: 8px 20px;
      border-radius: 8px;
      font-weight: 700;
      font-size: 1.1rem;
      margin-top: 8px;
    }

    .pump-off {
      background: #dcfce7;
      color: var(--green);
    }

    .pump-on {
      background: #dbeafe;
      color: var(--blue);
    }

    /* REASON BOX */
    .reason-box {
      background: #fefce8;
      border: 2px solid #fef08a;
      border-radius: 12px;
      padding: 20px;
      grid-column: 2 / 4;
    }

    .reason-title {
      font-size: 0.75rem;
      text-transform: uppercase;
      letter-spacing: 1px;
      color: var(--amber);
      margin-bottom: 8px;
      font-weight: 600;
    }

    .reason-text {
      font-size: 1.25rem;
      font-weight: 600;
      color: #92400e;
      line-height: 1.4;
    }

    .impact-text {
      margin-top: 12px;
      font-size: 0.95rem;
      color: #a16207;
    }

    /* SENSOR CARDS */
    .card {
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 20px;
    }

    .card-title {
      font-size: 0.7rem;
      text-transform: uppercase;
      letter-spacing: 1px;
      color: var(--muted);
      margin-bottom: 12px;
    }

    .card-value {
      font-size: 2.2rem;
      font-weight: 700;
    }

    .card-unit {
      font-size: 0.85rem;
      color: var(--muted);
      margin-left: 4px;
    }

    .progress-bar {
      margin-top: 12px;
      height: 6px;
      background: #e2e8f0;
      border-radius: 4px;
      overflow: hidden;
    }

    .progress-fill {
      height: 100%;
      transition: width 0.5s ease;
    }

    /* AGENT TRACE */
    .trace-card {
      grid-column: 1 / -1;
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 20px;
    }

    .trace-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 16px;
    }

    .trace-title {
      font-size: 0.75rem;
      text-transform: uppercase;
      letter-spacing: 1px;
      color: var(--muted);
      font-weight: 600;
    }

    .trace-log {
      background: #f1f5f9;
      border-radius: 8px;
      padding: 16px;
      font-family: 'Consolas', monospace;
      font-size: 0.85rem;
      height: 180px;
      overflow-y: auto;
      color: #334155;
    }

    .log-entry {
      margin-bottom: 6px;
      line-height: 1.5;
    }

    .log-time {
      color: #94a3b8;
      margin-right: 8px;
    }

    .log-weather {
      color: var(--cyan);
    }

    .log-decision {
      color: var(--green);
      font-weight: 600;
    }

    .log-warning {
      color: var(--amber);
    }

    .log-sensor {
      color: var(--muted);
    }

    /* WEATHER WIDGET */
    .weather-widget {
      background: linear-gradient(135deg, #0ea5e9, #0284c7);
      color: white;
      border-radius: 12px;
      padding: 20px;
      text-align: center;
    }

    .weather-icon {
      font-size: 2.5rem;
      margin-bottom: 8px;
    }

    .weather-label {
      font-size: 0.75rem;
      text-transform: uppercase;
      letter-spacing: 1px;
      opacity: 0.8;
    }

    .weather-value {
      font-size: 1.5rem;
      font-weight: 700;
      margin-top: 4px;
    }

    /* METRICS ROW */
    .metrics-row {
      display: flex;
      gap: 16px;
      margin-top: 16px;
    }

    .metric-chip {
      background: #f1f5f9;
      padding: 8px 16px;
      border-radius: 8px;
      font-size: 0.85rem;
    }

    .metric-label {
      color: var(--muted);
      margin-right: 6px;
    }

    .metric-value {
      font-weight: 700;
    }
  </style>
</head>

<body>

  <header>
    <div class="brand">üå± AgroSense AI</div>
    <div class="status-badge">
      <div class="pulse"></div>
      LIVE MONITORING
    </div>
  </header>

  <div class="main-grid">

    <!-- DECISION HERO -->
    <div class="decision-hero">
      <div class="decision-block">
        <div class="decision-label">AI Decision</div>
        <div class="decision-value" id="decision">HOLD</div>
        <div class="pump-status pump-off" id="pumpStatus">PUMP OFF</div>
      </div>

      <div class="reason-box">
        <div class="reason-title">üí° Reason</div>
        <div class="reason-text" id="reasonText">Rain expected in 1 hour 28 minutes</div>
        <div class="impact-text" id="impactText">üíß ~40 liters of water saved</div>
      </div>
    </div>

    <!-- SENSOR CARDS -->
    <div class="card">
      <div class="card-title">Soil Moisture</div>
      <div>
        <span class="card-value" id="soil">--</span>
        <span class="card-unit">%</span>
      </div>
      <div class="progress-bar">
        <div id="soilBar" class="progress-fill" style="width:0%; background: #2563eb;"></div>
      </div>
      <div class="metrics-row">
        <div class="metric-chip">
          <span class="metric-label">Threshold:</span>
          <span class="metric-value">30%</span>
        </div>
      </div>
    </div>

    <div class="card">
      <div class="card-title">Temperature</div>
      <div>
        <span class="card-value" id="temp">--</span>
        <span class="card-unit">¬∞C</span>
      </div>
      <div class="progress-bar">
        <div id="tempBar" class="progress-fill" style="width:0%; background: #d97706;"></div>
      </div>
    </div>

    <div class="weather-widget">
      <div class="weather-icon">üåßÔ∏è</div>
      <div class="weather-label">Rain Forecast</div>
      <div class="weather-value" id="rainForecast">In 1h 28m</div>
    </div>

    <div class="card">
      <div class="card-title">Light Level</div>
      <div>
        <span class="card-value" id="light">--</span>
        <span class="card-unit">lux</span>
      </div>
    </div>

    <!-- AGENT TRACE -->
    <div class="trace-card">
      <div class="trace-header">
        <div class="trace-title">üß† Agent Reasoning Trace</div>
      </div>
      <div class="trace-log" id="traceLog">
        <div class="log-entry"><span class="log-time">[--:--]</span> System initialized. Waiting for telemetry...</div>
      </div>
    </div>

  </div>

  <script>
    let API = localStorage.getItem("agro_api") || "http://localhost:5000";
    const traceLog = document.getElementById("traceLog");
    let lastSignature = "";

    function log(msg, type = "") {
      const time = new Date().toLocaleTimeString('en-US', { hour12: false, hour: '2-digit', minute: '2-digit', second: '2-digit' });
      const div = document.createElement("div");
      div.className = "log-entry";
      div.innerHTML = `<span class="log-time">[${time}]</span><span class="log-${type}">${msg}</span>`;
      traceLog.appendChild(div);
      traceLog.scrollTop = traceLog.scrollHeight;
    }

    async function fetchState() {
      try {
        const res = await fetch(API.replace(/\/$/, "") + "/state");
        const data = await res.json();
        if (!data.sensors) return;

        // Update sensors
        document.getElementById("soil").innerText = data.sensors.soil;
        document.getElementById("temp").innerText = data.sensors.temperature;
        document.getElementById("light").innerText = data.sensors.light;

        document.getElementById("soilBar").style.width = Math.min(data.sensors.soil, 100) + "%";
        document.getElementById("tempBar").style.width = Math.min(data.sensors.temperature * 2, 100) + "%";

        // Update decision
        const decision = data.agent_analysis?.decision || "HOLD";
        const decisionEl = document.getElementById("decision");
        decisionEl.innerText = decision;
        decisionEl.className = "decision-value " + decision;

        // Update pump status
        const pumpEl = document.getElementById("pumpStatus");
        if (decision === "IRRIGATE") {
          pumpEl.innerText = "PUMP ON";
          pumpEl.className = "pump-status pump-on";
        } else {
          pumpEl.innerText = "PUMP OFF";
          pumpEl.className = "pump-status pump-off";
        }

        // Update reason
        if (data.rain_forecast) {
          document.getElementById("rainForecast").innerText = data.rain_forecast;
        }
        if (data.reason) {
          document.getElementById("reasonText").innerText = data.reason;
        }
        if (data.impact) {
          document.getElementById("impactText").innerText = "üíß " + data.impact;
        }

        // Agent logs
        const signature = JSON.stringify(data.agent_logs || []);
        if (signature !== lastSignature && data.agent_logs) {
          lastSignature = signature;
          data.agent_logs.forEach(entry => {
            let type = "sensor";
            if (entry.includes("Rain") || entry.includes("Weather")) type = "weather";
            if (entry.includes("Decision") || entry.includes("HOLD") || entry.includes("IRRIGATE")) type = "decision";
            if (entry.includes("‚ö†")) type = "warning";
            log(entry, type);
          });
        }

      } catch (e) {
        console.log("Backend unreachable");
      }
    }

    setInterval(fetchState, 2000);
    fetchState();
    log("Connecting to AgroSense AI backend...", "sensor");
  </script>

</body>

</html>